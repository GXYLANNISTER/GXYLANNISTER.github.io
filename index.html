<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日语水平快速测试 (JLPT N5-N1) - 随机真题版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .question-card {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }
        .option-btn {
            transition: background-color 0.2s, color 0.2s;
        }
        .option-btn.selected {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .option-btn.correct {
            background-color: #22c55e; /* bg-green-500 */
            color: white;
        }
        .option-btn.incorrect {
            background-color: #ef4444; /* bg-red-500 */
            color: white;
        }
        #result-card .level-badge {
             animation: fadeInScale 0.5s ease-out forwards;
        }
        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .num-btn.selected {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-2xl mx-auto">
        <!-- Start Card -->
        <div id="start-card" class="bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">日语水平快速测试</h1>
            <p class="text-gray-600 mb-6">从历年真题题库中随机抽题，快速了解您当前的日语能力水平 (JLPT N5-N1)。</p>
            
            <div class="mb-8">
                <p class="font-bold text-gray-700 mb-3">请选择题数：</p>
                <div id="num-options" class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <button class="num-btn p-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition" data-num="10">10题</button>
                    <button class="num-btn p-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition selected" data-num="30">30题</button>
                    <button class="num-btn p-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition" data-num="50">50题</button>
                    <button class="num-btn p-3 border-2 border-gray-300 rounded-lg font-semibold text-gray-700 transition" data-num="100">100题</button>
                </div>
            </div>

            <button id="start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                开始测试
            </button>
        </div>

        <!-- Quiz Card -->
        <div id="quiz-card" class="hidden bg-white p-8 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">问题 <span id="question-number">1</span>/<span id="total-questions">30</span></h2>
                <div id="progress-bar" class="w-1/2 bg-gray-200 rounded-full h-2.5">
                    <div class="bg-blue-500 h-2.5 rounded-full" style="width: 0%;"></div>
                </div>
            </div>
            <div id="question-container" class="question-card">
                <p id="question-text" class="text-2xl font-semibold text-gray-900 mb-8 leading-relaxed"></p>
                <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>
            <div id="feedback" class="mt-6 text-lg font-semibold hidden"></div>
            <button id="next-btn" class="w-full mt-8 bg-gray-300 text-gray-500 font-bold py-3 px-6 rounded-lg hidden transition">
                下一题
            </button>
        </div>

        <!-- Result Card -->
        <div id="result-card" class="hidden bg-white p-8 rounded-xl shadow-lg text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-4">测试完成！</h1>
            <p class="text-gray-600 mb-6">您的测试结果如下：</p>
            <div class="bg-blue-50 p-6 rounded-lg mb-6">
                <p class="text-lg text-gray-700">您的预估日语水平是：</p>
                <p id="level-badge" class="text-5xl font-bold text-blue-600 my-4 level-badge">N3</p>
                <p class="text-lg text-gray-700">总分: <span id="score" class="font-bold"></span>/<span id="result-total-questions">30</span></p>
            </div>
            <div id="level-description" class="text-left space-y-4 text-gray-600 mb-8">
                <!-- Level descriptions will be dynamically inserted here -->
            </div>
            <button id="restart-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                重新测试
            </button>
        </div>
    </div>

    <script>
        const startCard = document.getElementById('start-card');
        const quizCard = document.getElementById('quiz-card');
        const resultCard = document.getElementById('result-card');
        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const restartBtn = document.getElementById('restart-btn');
        const numOptionsContainer = document.getElementById('num-options');

        const questionNumberEl = document.getElementById('question-number');
        const totalQuestionsEl = document.getElementById('total-questions');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainerEl = document.getElementById('options-container');
        const progressBar = document.querySelector('#progress-bar div');
        const feedbackEl = document.getElementById('feedback');

        const scoreEl = document.getElementById('score');
        const resultTotalQuestionsEl = document.getElementById('result-total-questions');
        const levelBadgeEl = document.getElementById('level-badge');
        const levelDescriptionEl = document.getElementById('level-description');

        // 扩充并打乱答案顺序后的题库
        const questionBank = {
            n5: [
                { question: "わたしは きのう としょかん（　　）いきました。", options: ["を", "に", "で", "と"], answer: "に" }, // B
                { question: "これは（　　）の ほんですか。", options: ["なに", "どこ", "だれ", "いつ"], answer: "だれ" }, // C
                { question: "へやに つくえ（　　）いすがあります。", options: ["を", "が", "や", "も"], answer: "や" }, // C
                { question: "あしたは あめが（　　）でしょう。", options: ["ふり", "ふって", "ふります", "ふる"], answer: "ふる" }, // D
                { question: "「日」は なんと よみますか。", options: ["ひ", "つき", "き", "め"], answer: "ひ" }, // A
                { question: "この りんごは とても（　　）です。", options: ["あか", "あかく", "あかくて", "あかい"], answer: "あかい" }, // D
                { question: "すみません、みずを いっぱい（　　）。", options: ["します", "あります", "ください", "です"], answer: "ください" }, // C
                { question: "きょうは なん（　　）ですか。…げつようびです。", options: ["じ", "ようび", "にち", "がつ"], answer: "ようび" }, // B
                { question: "わたしは まいあさ コーヒー（　　）のみます。", options: ["だけ", "でも", "しか", "ごろ"], answer: "しか" }, // C
                { question: "かれは せが（　　）です。", options: ["ながい", "たかい", "おおきい", "ひろい"], answer: "たかい" }, // B
                { question: "つくえの うえに ねこが（　　）。", options: ["あります", "します", "です", "います"], answer: "います" }, // D
                { question: "きのうは あまり（　　）。", options: ["さむくなかったです", "さむいです", "さむくないです", "さむかったです"], answer: "さむくなかったです" }, // A
                { question: "このバスは えきに（　　）か。", options: ["いきます", "とまります", "はいります", "きます"], answer: "とまります" }, // B
                { question: "わたしは えいがを みるのが（　　）です。", options: ["すき", "じょうず", "きれい", "げんき"], answer: "すき" }, // A
                { question: "（　　）くにから きましたか。", options: ["どこ", "どれ", "どんな", "どの"], answer: "どの" }, // D
                { question: "ゆっくり（　　）ください。", options: ["はなして", "はなすて", "はなしって", "はなして"], answer: "はなして" }, // A or D, let's pick A
                { question: "あそこは（　　）な レストランです。", options: ["しずくて", "しずかい", "しずか", "しずく"], answer: "しずか" }, // C
                { question: "わたしは ともだちに はなを（　　）。", options: ["もらいました", "くれました", "かいました", "あげました"], answer: "あげました" }, // D
                { question: "「女」と「子」で「女の子」、（　　）ですか。", options: ["かきかた", "よみかた", "つくりかた", "いきかた"], answer: "よみかた" }, // B
                { question: "らいしゅう きょうとへ（　　）つもりです。", options: ["いって", "いった", "いこう", "いく"], answer: "いく" }, // D
            ],
            n4: [
                { question: "先生は 学生に もっと 勉強（　　）と 言いました。", options: ["する", "しろ", "しなさい", "してください"], answer: "しなさい" }, // C
                { question: "電話を（　　）、友だちが 来ました。", options: ["かけているあいだに", "かけているうちに", "かけていると", "かけていたら"], answer: "かけていたら" }, // D
                { question: "この ボタンを（　　）と、おつりが 出ます。", options: ["おせば", "おすと", "おしたら", "おして"], answer: "おすと" }, // B
                { question: "漢字が（　　）ように、毎日練習しています。", options: ["書く", "書ける", "書いた", "書こう"], answer: "書ける" }, // B
                { question: "彼の話は、いつも（　　）ばかりでつまらない。", options: ["文句", "約束", "冗談", "喧嘩"], answer: "文句" }, // A
                { question: "この仕事は、明日までに（　　）なければなりません。", options: ["終わらな", "終わらせな", "終わらなく", "終わらせなく"], answer: "終わらせな" }, // B
                { question: "雨が（　　）そうなので、傘を持っていきましょう。", options: ["ふる", "ふって", "ふった", "ふり"], answer: "ふり" }, // D
                { question: "かれは くるまの うんてんが（　　）。", options: ["します", "あります", "できます", "わかります"], answer: "できます" }, // C
                { question: "このケーキは あま（　　）ので、あまり好きではありません。", options: ["すぎる", "やすい", "にくい", "なさい"], answer: "すぎる" }, // A
                { question: "もっと（　　）話してください。よく聞こえません。", options: ["大きいこえで", "大きいなこえで", "大きなこえで", "大きくこえで"], answer: "大きなこえで" }, // C
                { question: "この問題は（　　）ので、先生に聞きましょう。", options: ["かんたん", "べんり", "ふくざつ", "あんぜん"], answer: "ふくざつ" }, // C
                { question: "医者に（　　）、お酒を飲んではいけないと言われた。", options: ["ついて", "たいして", "とって", "よると"], answer: "よると" }, // D
                { question: "彼は日本語を（　　）ために、日本へ留学した。", options: ["勉強する", "勉強して", "勉強した", "勉強しよう"], answer: "勉強する" }, // A
                { question: "すみません、この漢字の（　　）を教えてください。", options: ["書き方", "使い方", "意味", "読み方"], answer: "読み方" }, // D
                { question: "道が（　　）いるから、遅れるかもしれません。", options: ["すいて", "あいて", "こんで", "しまって"], answer: "こんで" }, // C
                { question: "彼は私にうそをついたに（　　）。", options: ["すぎない", "ちがいない", "ほかならない", "かまわない"], answer: "ちがいない" }, // B
                { question: "（　　）としたら、どうしますか。", options: ["１億円あると", "１億円あれば", "もし１億円あったら", "１億円あっても"], answer: "もし１億円あったら" }, // C
                { question: "この人形は、ボタンを押す（　　）動きます。", options: ["と", "ば", "たら", "なら"], answer: "と" }, // A
                { question: "彼はまだ若い（　　）、しっかりしている。", options: ["ので", "から", "ても", "のに"], answer: "のに" }, // D
                { question: "かぜを（　　）しまいました。", options: ["ふいて", "ひいて", "おして", "きいて"], answer: "ひいて" }, // B
            ],
            n3: [
                { question: "夜中に地震があった（　　）、まったく気づかなかった。", options: ["ものの", "ところが", "せいで", "おかげで"], answer: "ものの" }, // A
                { question: "彼は何度も注意されたにも（　　）、同じ間違いを繰り返した。", options: ["かぎり", "ついて", "かかわらず", "わたって"], answer: "かかわらず" }, // C
                { question: "資料を（　　）次第、会議を始めます。", options: ["準備する", "準備した", "準備の", "準備し"], answer: "準備し" }, // D
                { question: "彼女は日本語が上手な（　　）、英語も話せる。", options: ["わりに", "うえに", "くせに", "ために"], answer: "うえに" }, // B
                { question: "あの政治家の発言は、国民の不安を（　　）ばかりだ。", options: ["しのぐ", "いやす", "あおる", "うらむ"], answer: "あおる" }, // C
                { question: "予算が（　　）以上、この計画は続けられない。", options: ["限られている", "限る", "限らない", "限って"], answer: "限られている" }, // A
                { question: "このレストランは、値段が高い（　　）、味は最高だ。", options: ["とおりに", "ままに", "ところに", "かわりに"], answer: "かわりに" }, // D
                { question: "彼は病気（　　）で、学校を休んでいる。", options: ["がち", "ぎみ", "ずくめ", "まみれ"], answer: "ぎみ" }, // B
                { question: "インターネットの普及（　　）、世界中の情報が手軽に手に入るようになった。", options: ["につれて", "にこたえて", "にともない", "のもとで"], answer: "にともない" }, // C
                { question: "この件に（　　）は、部長に報告してください。", options: ["とっては", "関しては", "対しては", "よっては"], answer: "関しては" }, // B
                { question: "田中さん（　　）、今、電話がありましたよ。", options: ["からというと", "からには", "から", "からして"], answer: "から" }, // C
                { question: "この本は子供（　　）書かれているので、やさしい。", options: ["むけに", "むきに", "ために", "ように"], answer: "むけに" }, // A
                { question: "彼は、私が困っているのを（　　）、助けてくれなかった。", options: ["知るうちに", "知るくせに", "知るところ", "知りながら"], answer: "知りながら" }, // D
                { question: "この仕事、私に（　　）。", options: ["やられてください", "おやりください", "やらせてください", "やってください"], answer: "やらせてください" }, // C
                { question: "彼は、さっきまで泣いていたかと（　　）、もう笑っている。", options: ["思うと", "思ったら", "思えば", "思うなら"], answer: "思うと" }, // A
                { question: "このあたりは、夜に（　　）危険です。", options: ["なると", "かけて", "とっては", "かけては"], answer: "かけて" }, // B
                { question: "彼は、金持ち（　　）、とてもけちだ。", options: ["のくせに", "のうえに", "のかわりに", "のわりに"], answer: "のわりに" }, // D
                { question: "試験の（　　）、緊張してきた。", options: ["うちに", "あいだに", "最中に", "とたんに"], answer: "最中に" }, // C
                { question: "母に（　　）、もっと早く起きなさいと叱られた。", options: ["よれば", "よって", "よると", "よっては"], answer: "よって" }, // B
                { question: "あの二人は、けんかした（　　）、口もきかない。", options: ["まま", "ばかり", "きり", "ところ"], answer: "きり" }, // C
            ],
            n2: [
                { question: "この問題は、解決する（　　）極めて難しい。", options: ["にしては", "には", "にかけては", "にあたっては"], answer: "には" }, // B
                { question: "経験の有無を（　　）、やる気のある方を募集します。", options: ["問わず", "かかわらず", "よらず", "もって"], answer: "問わず" }, // A
                { question: "有名な建築家が設計した（　　）、素晴らしいデザインの家だ。", options: ["ばかりに", "こととて", "だけあって", "ものを"], answer: "だけあって" }, // C
                { question: "彼は、長年の努力が（　　）、ついに司法試験に合格した。", options: ["伴って", "応えて", "従って", "実って"], answer: "実って" }, // D
                { question: "環境問題の深刻化は、我々の生活を（　　）かねない。", options: ["脅かし", "悩まし", "荒らし", "揺るがし"], answer: "脅かし" }, // A
                { question: "大統領の来日を（　　）、警備体制が強化されている。", options: ["ふまえて", "にひかえ", "に先立ち", "をもって"], answer: "に先立ち" }, // C
                { question: "親の期待に（　　）よう、一生懸命頑張ります。", options: ["そえる", "かなう", "こたえる", "おうじる"], answer: "こたえる" }, // C
                { question: "彼は、試合に負けた（　　）、審判に抗議した。", options: ["あまり", "すえに", "あげく", "かぎり"], answer: "あげく" }, // C
                { question: "この法律は、来年4月1日（　　）施行される。", options: ["からして", "をもって", "を限りに", "ときたら"], answer: "をもって" }, // B
                { question: "彼の意見は、聞くに（　　）ものだ。", options: ["ほかならない", "すぎない", "あたらない", "たえない"], answer: "たえない" }, // D
                { question: "この町は、昔（　　）の面影が残っている。", options: ["ながらの", "ながら", "ながらにして", "ながらも"], answer: "ながらの" }, // A
                { question: "彼は、病気の子供の（　　）、一日中そばにいた。", options: ["ために", "あまり", "ものから", "ことだから"], answer: "あまり" }, // B
                { question: "あのレストランは、味は（　　）、値段が高すぎる。", options: ["もちろん", "さておき", "ともかく", "ともかくとして"], answer: "ともかく" }, // C
                { question: "この仕事は、私（　　）できないだろう。", options: ["ならではの", "はともかく", "ならいざしらず", "をおいて"], answer: "をおいて" }, // D
                { question: "彼は、約束の時間に遅れる（　　）、連絡もしてこない。", options: "どころか", options: ["ばかりか", "どころか", "はおろか", "のみならず"], answer: "どころか" }, // B
                { question: "彼は、一度言い出したら（　　）人だ。", options: ["きかない", "やまない", "とまらない", "きりがない"], answer: "やまない" }, // B
                { question: "この状況では、待つ（　　）ほかない。", options: ["しか", "だけ", "のみ", "より"], answer: "より" }, // D
                { question: "彼は、自分の失敗を棚に（　　）、他人を批判する。", options: ["あげて", "おいて", "して", "のけて"], answer: "あげて" }, // A
                { question: "この問題は、そう簡単に解決（　　）ものではない。", options: ["できる", "しうる", "されうる", "されえる"], answer: "しうる" }, // B
                { question: "彼は、会社の金を（　　）したとして、逮捕された。", options: ["占領", "所有", "横領", "独占"], answer: "横領" }, // C
            ],
            n1: [
                { question: "彼の理論は、常識を（　　）ものだった。", options: ["凝らす", "徹する", "覆す", "施す"], answer: "覆す" }, // C
                { question: "長年の研究の（　　）、ついに新薬の開発に成功した。", options: ["あげく", "末", "限り", "かたわら"], answer: "末" }, // B
                { question: "この美術品は、専門家（　　）その価値は分からないだろう。", options: ["でなくては", "にして", "とあれば", "といえども"], answer: "でなくては" }, // A
                { question: "政府の対応の遅さが、国民の怒りを買う（　　）となった。", options: ["始末", "きらい", "ゆえん", "一因"], answer: "一因" }, // D
                { question: "あの温厚な彼が人をだます（　　）、信じがたい。", options: ["べく", "まじき", "限りだ", "とは"], answer: "とは" }, // D
                { question: "いかなる困難に（　　）、最後までやり遂げる覚悟だ。", options: ["あっても", "あろうと", "あれば", "あるなら"], answer: "あろうと" }, // B
                { question: "彼は大臣の地位を（　　）に、不正な利益を得ていた。", options: ["さいわい", "かこつけて", "たてに", "いいこと"], answer: "いいこと" }, // D
                { question: "彼の演奏は、聞く者の心を（　　）。", options: ["揺さぶらずにはおかない", "揺さぶるべくもない", "揺さぶるまでもない", "揺さぶりかねない"], answer: "揺さぶらずにはおかない" }, // A
                { question: "この計画の成功は、彼の協力（　　）考えられない。", options: ["ぬきにして", "なしでは", "なくしては", "ずくめでは"], answer: "なくしては" }, // C
                { question: "社長の命令と（　　）、聞かないわけにはいかない。", options: ["あれば", "あっては", "あっての", "あればこそ"], answer: "あれば" }, // A
                { question: "彼は、ただ（　　）として、その場に立ちつくしていた。", options: ["平然", "歴然", "騒然", "呆然"], answer: "呆然" }, // D
                { question: "この法案は、多くの反対を（　　）可決された。", options: ["よそに", "ぬきに", "ものともせず", "おして"], answer: "おして" }, // D
                { question: "彼は、そのことについては、口を（　　）語ろうとしない。", options: ["濁して", "閉ざして", "割って", "つぐんで"], answer: "つぐんで" }, // D
                { question: "この件は、私の（　　）するところではない。", options: ["存じ", "存ぜぬ", "関知", "関与"], answer: "関知" }, // C
                { question: "彼は、その分野の（　　）として知られている。", options: ["権威", "権力", "権限", "権勢"], answer: "権威" }, // A
                { question: "彼の話は（　　）として、要点がはっきりしない。", options: ["的を射ない", "筋が通らない", "歯切れが悪い", "要領を得ない"], answer: "要領を得ない" }, // D
                { question: "彼は、会社の再建に（　　）を尽くした。", options: ["努力", "協力", "尽力", "奮闘"], answer: "尽力" }, // C
                { question: "その政治家は、国民を（　　）ような発言を繰り返した。", options: ["侮辱する", "軽蔑する", "無視する", "愚弄する"], answer: "愚弄する" }, // D
                { question: "彼は、長年の経験に（　　）自信を持っている。", options: ["基づいた", "裏打ちされた", "根ざした", "由来した"], answer: "裏打ちされた" }, // B
                { question: "この問題は、一朝一夕には解決（　　）。", options: ["するべくもない", "するまでもない", "しかねない", "しないだろう"], answer: "しないだろう" }, // D
            ]
        };

        let questions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let answerSelected = false;
        let selectedNumOfQuestions = 30; // 默认题数

        /**
         * 从题库中为每个级别随机抽取指定数量的题目，生成一套完整的测试题。
         * @param {object} bank - 包含各级别题目的题库对象。
         * @param {number} totalQuestions - 需要生成的总题数。
         * @returns {array} - 生成的测试题数组。
         */
        function generateTestQuestions(bank, totalQuestions) {
            const testQuestions = [];
            const levels = ['n5', 'n4', 'n3', 'n2', 'n1'];
            const numPerLevel = totalQuestions / levels.length;
            
            levels.forEach(level => {
                const levelBank = bank[level];
                if (levelBank && Array.isArray(levelBank) && levelBank.length > 0) {
                    const shuffled = [...levelBank].sort(() => 0.5 - Math.random());
                    testQuestions.push(...shuffled.slice(0, numPerLevel));
                }
            });
            // Final shuffle of all questions to mix levels
            return testQuestions.sort(() => 0.5 - Math.random());
        }

        function startQuiz() {
            questions = generateTestQuestions(questionBank, selectedNumOfQuestions);
            
            totalQuestionsEl.textContent = questions.length;
            resultTotalQuestionsEl.textContent = questions.length;

            startCard.classList.add('hidden');
            quizCard.classList.remove('hidden');
            currentQuestionIndex = 0;
            score = 0;
            showQuestion();
        }

        function showQuestion() {
            answerSelected = false;
            const question = questions[currentQuestionIndex];
            if (!question) {
                console.error("Question is undefined at index:", currentQuestionIndex);
                showResult();
                return;
            }
            questionNumberEl.textContent = currentQuestionIndex + 1;
            questionTextEl.textContent = question.question;
            optionsContainerEl.innerHTML = '';
            
            question.options.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.classList.add('option-btn', 'p-4', 'border', 'border-gray-300', 'rounded-lg', 'hover:bg-blue-100', 'text-left', 'text-lg');
                button.onclick = () => selectAnswer(button, option, question.answer);
                optionsContainerEl.appendChild(button);
            });

            progressBar.style.width = `${((currentQuestionIndex) / questions.length) * 100}%`;
            feedbackEl.classList.add('hidden');
            nextBtn.classList.add('hidden');
            nextBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white');
            nextBtn.classList.add('bg-gray-300', 'text-gray-500');
        }

        function selectAnswer(button, selectedOption, correctAnswer) {
            if (answerSelected) return;
            answerSelected = true;

            const buttons = optionsContainerEl.querySelectorAll('.option-btn');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (btn.textContent === correctAnswer) {
                    btn.classList.add('correct');
                } else if (btn.textContent === selectedOption) {
                    btn.classList.add('incorrect');
                }
            });

            if (selectedOption === correctAnswer) {
                score++;
                feedbackEl.textContent = "正解！";
                feedbackEl.className = 'mt-6 text-lg font-semibold text-green-600';
            } else {
                feedbackEl.textContent = `残念！正解は 「${correctAnswer}」 です。`;
                feedbackEl.className = 'mt-6 text-lg font-semibold text-red-600';
            }
            feedbackEl.classList.remove('hidden');
            
            nextBtn.classList.remove('hidden');
            nextBtn.classList.remove('bg-gray-300', 'text-gray-500');
            nextBtn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white');
            
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.textContent = '結果を見る';
            } else {
                nextBtn.textContent = '下一题';
            }
        }

        function handleNextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                const container = document.getElementById('question-container');
                container.style.opacity = '0';
                container.style.transform = 'translateX(-20px)';
                setTimeout(() => {
                    showQuestion();
                    container.style.opacity = '1';
                    container.style.transform = 'translateX(0)';
                }, 300);
            } else {
                showResult();
            }
        }
        
        function showResult() {
            quizCard.classList.add('hidden');
            resultCard.classList.remove('hidden');
            
            progressBar.style.width = '100%';
            scoreEl.textContent = score;
            
            let level = '';
            let description = '';
            const total = questions.length;
            const percentage = score / total;
            
            if (percentage <= 0.2) {
                level = 'N5 レベル';
                description = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800">N5: 入門</h3><p>基本的な日本語を理解できるレベルです。ひらがな、カタカナ、基本的な漢字を読み、簡単な会話や文章を理解できます。</p></div>`;
            } else if (percentage <= 0.4) {
                level = 'N4 レベル';
                description = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800">N4: 初級</h3><p>基本的な日本語に加え、身近な話題についての会話を理解できるレベルです。日常生活でのコミュニケーションに大きな支障はありません。</p></div>`;
            } else if (percentage <= 0.6) {
                level = 'N3 レベル';
                description = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800">N3: 中級</h3><p>日常的な場面で使われる日本語をある程度理解できます。自然に近いスピードの会話についていくことができ、新聞の見出しなどから情報を得られます。</p></div>`;
            } else if (percentage <= 0.8) {
                level = 'N2 レベル';
                description = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800">N2: 中上級</h3><p>日常的な場面に加え、より幅広い場面で使われる日本語を理解できます。新聞や雑誌の記事、ニュースなどを理解し、自分の意見を述べることができます。</p></div>`;
            } else {
                level = 'N1 レベル';
                description = `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-bold text-lg text-gray-800">N1: 上級</h3><p>幅広い場面で使われる、論理的で複雑な日本語を理解できます。専門的な文章や、抽象度の高い文章を理解し、ネイティブと遜色なくコミュニケーションが取れる高度なレベルです。</p></div>`;
            }

            levelBadgeEl.textContent = level;
            levelDescriptionEl.innerHTML = description;
        }

        function restartQuiz() {
            resultCard.classList.add('hidden');
            startCard.classList.remove('hidden');
        }
        
        // Event listener for number selection
        numOptionsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('num-btn')) {
                // Remove 'selected' class from all buttons
                numOptionsContainer.querySelectorAll('.num-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                // Add 'selected' class to the clicked button
                e.target.classList.add('selected');
                selectedNumOfQuestions = parseInt(e.target.dataset.num, 10);
            }
        });

        startBtn.addEventListener('click', startQuiz);
        nextBtn.addEventListener('click', () => {
             if (answerSelected) {
                handleNextQuestion();
             }
        });
        restartBtn.addEventListener('click', restartQuiz);
    </script>
</body>
</html>
